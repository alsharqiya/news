(function(){"use strict";$(document).ready(function(){var player=irubataru.tinyPlayer.createPlayerFromTags();});var irubataru={tinyPlayer:{Player:class{constructor(playlist){this._playlist=playlist;this._index=0;this._mouse_down=false;this._seeking=false;this._animation_timestamp=0;this.ns=irubataru.tinyPlayer;}
play(index){var self=this;index=typeof index==="number"?index:self._index;var sound=self._playlist[index].howl;sound.play();self._index=index;}
pause(index){var self=this;index=typeof index==="number"?index:self._index;var sound=self._playlist[index].howl;if(sound){sound.pause();}}
stop(index){var self=this;index=typeof index==="number"?index:self._index;var sound=self._playlist[index].howl;sound.stop();self._index=index;}
toggleTo(index){var self=this;var sound=self._playlist[self._index].howl;if(sound.playing()){if(index===self._index){self.pause();return;}else{sound.stop();}}
self.play(index);}
seek(index,percentage){var self=this;var ns=this.ns;var sound=self._playlist[index].howl;var html_elem=self._playlist[index].html_elem;var seek_to=percentage*sound.duration();sound.seek(seek_to);html_elem.find(".song-timer").html(ns._formatTime(seek_to)+" / "+ns._formatTime(sound.duration()));}
updateDuration(index,percentage){var self=this;var html_elem=self._playlist[index].html_elem;html_elem.find(".song-progress").css("width",(percentage*100||0)+"%");}
volume(val){var self=this;Howler.volume(val);var barWidth=(val*60)/100;self._playlist.forEach(function(song){song.html_elem.find(".song-volume-bar#fg").css("width",val*60+"%");song.html_elem.find(".song-volume-dot").css("left",val*60+20+"%");});}
step(timestamp){var self=this;var ns=this.ns;var sound=self._playlist[self._index].howl;var html_elem=self._playlist[self._index].html_elem;var seek=sound.seek()||0;html_elem.find(".song-timer").html(ns._formatTime(seek)+" / "+ns._formatTime(sound.duration()));if(!self._seeking){self.updateDuration(self._index,seek/sound.duration());}
var title=html_elem.find(".song-title");if(sound.playing()){requestAnimationFrame(self.step.bind(self));}}},createPlayerFromTags:function(){var ns=this;var playlist=[];$("audio.iru-tiny-player").each(function(){let title="";if($(this).attr("data-title")){title=$(this).attr("data-title");}else{title=$(this).prevUntil("audio",":header").first().html();}
let files=[];$(this).children("source").each(function(){files.push($(this).attr("src"));});var song_elem=ns.createSongPlayer(title);playlist.push({title:title,files:files,html_elem:song_elem,howl:null});$(this).after(song_elem);$(this).hide();});var player=new ns.Player(playlist);ns._setupEvents(player);return player;},createSongPlayer:function(title){return $("<div>").addClass("iru-tiny-player").append($("<div>").addClass("song-seek")).append($("<div>").addClass("song-progress")).append($("<div>").addClass("song-main-info").append($('<div class="icon fa-play">')).append($('<div class="icon fa-pause">').hide()).append($('<div class="icon fa-stop">')).append($('<div class="song-title">').html(title+"  ")).append($("<div>").addClass("song-timer")).append($('<div class="icon fa-volume-up">'))).append($("<div>").addClass("song-volume-control").hide().append($("<div>").addClass("song-volume-bar").attr("id","bg")).append($("<div>").addClass("song-volume-bar").attr("id","fg")).append($("<div>").addClass("song-volume-bar").attr("id","fgg")).append($("<div>").addClass("song-volume-dot")).append($("<div>").addClass("icon fa-times")));},_setupEvents:function(player){var ns=this;var song_index=0;player._playlist.forEach(function(song){var song_elem=song.html_elem;var this_idx=song_index;song.howl=ns._createHowlForPlayer(player,song);ns._bindPlayerControls(player,song_elem,this_idx);++song_index;});},_createHowlForPlayer:function(player,song){var song_elem=song.html_elem;var ns=this;return new Howl({src:song.files,html5:true,onplay:function(){song_elem.find(".fa-play").hide();song_elem.find(".fa-pause").show();requestAnimationFrame(player.step.bind(player));},onload:function(){var self=this;song_elem.find(".song-timer").html(ns._formatTime(self.duration()));},onend:function(){var self=this;song_elem.find(".song-timer").html(ns._formatTime(self.duration()));song_elem.find(".song-progress").css("width","0%");song_elem.find(".song-title").html(song.title+"  ");song_elem.find(".fa-pause").hide();song_elem.find(".fa-play").show();},onpause:function(){var self=this;song_elem.find(".fa-pause").hide();song_elem.find(".fa-play").show();},onstop:function(){var self=this;song_elem.find(".song-timer").html(ns._formatTime(self.duration()));song_elem.find(".song-progress").css("width","0%");song_elem.find(".song-title").html(song.title+"  ");song_elem.find(".fa-pause").hide();song_elem.find(".fa-play").show();}});},_bindPlayerControls:function(player,elem,idx){elem.find(".fa-play").click(function(){player.toggleTo(idx);});elem.find(".fa-pause").click(function(){player.pause(idx);});elem.find(".fa-stop").click(function(){player.stop(idx);});elem.find(".fa-volume-up").click(function(){elem.find(".song-volume-control").show();});elem.find(".fa-times").click(function(){elem.find(".song-volume-control").hide();});elem.find(".song-volume-bar#fgg").click(function(event){var x=event.pageX;x=x-elem.find(".song-volume-bar#bg").offset().left-7.5;var width=parseFloat(elem.find(".song-volume-bar#bg").innerWidth());var per=x/width;player.volume(per);});elem.find(".song-volume-dot").mousedown(function(){player._mouse_down=true;});elem.find(".song-volume-control").mouseup(function(){player._mouse_down=false;});elem.find(".song-volume-control").mousemove(function(event){if(player._mouse_down){var x=event.pageX;x=x-elem.find(".song-volume-bar#bg").offset().left-7.5;var width=parseFloat(elem.find(".song-volume-bar#bg").innerWidth());var per=Math.min(1,Math.max(0,x/width));player.volume(per);}});var _seekPercentage=function(event,elem,object_class){var x=event.pageX;x=x-elem.find(object_class).offset().left;var width=parseFloat(elem.find(".song-seek").innerWidth());return Math.min(1,Math.max(0,x/width));};elem.find(".song-seek").mousedown(function(event){player._seeking=true;player.updateDuration(idx,_seekPercentage(event,elem,".song-seek"));});elem.find(".song-seek").mousemove(function(event){if(player._seeking){player.updateDuration(idx,_seekPercentage(event,elem,".song-seek"));}});elem.find(".song-seek").mouseup(function(){player._seeking=false;player.seek(idx,_seekPercentage(event,elem,".song-seek"));});elem.find(".song-progress").mousedown(function(event){player._seeking=true;player.updateDuration(idx,_seekPercentage(event,elem,".song-progress"));});elem.find(".song-progress").mousemove(function(event){if(player._seeking){player.updateDuration(idx,_seekPercentage(event,elem,".song-progress"));}});elem.find(".song-progress").mouseup(function(){player._seeking=false;player.seek(_seekPercentage(idx,event,elem,".song-progress"));});},_formatTime:function(secs){var hours=Math.floor(secs/3600)||0;var minutes=Math.floor((secs-hours*3600)/60)||0;var seconds=Math.floor(secs-minutes*60)||0;if(hours>0){return(hours+
":"+
(minutes<10?"0":"")+
minutes+
":"+
(seconds<10?"0":"")+
seconds);}else{return minutes+":"+(seconds<10?"0":"")+seconds;}}}};if(typeof exports==="object"){exports.Player=irubataru.tinyPlayer.Player;exports.createPlayerFromTags=irubataru.tinyPlayer.createPlayerFromTags;exports.createSongPlayer=irubataru.tinyPlayer.createSongPlayer;}})();